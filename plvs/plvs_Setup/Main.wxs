<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?include version.wxi ?>

  <Product Id="2F0AD391-A3BB-4646-8BF4-6C46EF0DBAF9" 
           Name="$(loc.ProductName)" 
           Language="1033" 
           Version="$(var.ProgramVersion)" 
           Manufacturer="$(loc.Manufacturer)" 
           UpgradeCode="F849BFAF-EE21-43F8-8A9A-271DD07B4DA8">
    <Package Id="3C437EA0-D081-4311-8CBD-3493464DE70D" Platforms="Intel" Description="$(loc.Description)" Comments="$(loc.Comments)" Manufacturer="$(loc.Manufacturer)" InstallerVersion="200" Compressed="yes" Languages="1033" />

    <Media Id="1" Cabinet="Package.cab" EmbedCab="yes" />

    <!--Properties-->
    <Property Id="VSINSTALLDIR">
      <RegistrySearch Id="VSInstallRegistry" Root="HKLM" Key="SOFTWARE\Microsoft\VisualStudio\9.0" Name="InstallDir"  Type="directory" />
    </Property>
    <Property Id="FX20INSTALLED">
      <RegistrySearch Id="Fx20InstalledRegistry" Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v2.0.50727" Name="Install" Root="HKLM" Type="raw"/>
    </Property>
    <Property Id="FX35INSTALLED">
      <RegistrySearch Id="Fx35InstalledRegistry" Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v3.5" Name="Install" Root="HKLM" Type="raw"/>
    </Property>
    <Property Id="VSROOTDIR">
      <RegistrySearch Id="VSRootRegistry" Root="HKLM" Key="SOFTWARE\Microsoft\VisualStudio\9.0\Setup\VS" Name="ProductDir" Type="directory" />
    </Property>

    <!-- Add/Remove Programs -->
    <Property Id="ARPCONTACT"><![CDATA[$(loc.Manufacturer)]]></Property>
    <Property Id="ARPPRODUCTICON">ProductIcon</Property>
    <Property Id="ARPURLINFOABOUT"><![CDATA[http://www.atlassian.com]]></Property>

    <Property Id="ALLUSERS">2</Property>

    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />

    <Upgrade Id="F849BFAF-EE21-43F8-8A9A-271DD07B4DA8">
      <UpgradeVersion OnlyDetect='no' Property='PROJECT_UPGRADE' Maximum='$(var.ProgramVersion)' IncludeMaximum='no' RemoveFeatures='all'/>
      <Property Id='PROJECT_UPGRADE' Secure='yes'/>

      <UpgradeVersion OnlyDetect='yes' Property='PROJECT_DOWNGRADE' Minimum='$(var.ProgramVersion)' IncludeMinimum='no'/>
      <Property Id='PROJECT_DOWNGRADE' Secure='yes'/>

    </Upgrade>

    <CustomAction Id='NoDownGrade' Error='A later version of [loc.ProductName] is already installed.' />

    <!--    <Upgrade Id="F849BFAF-EE21-43F8-8A9A-271DD07B4DA8">-->
<!--      <UpgradeVersion-->
<!--         Minimum="0.0.1.0" Maximum="99.0.0.0"-->
<!--         Property="PREVIOUSVERSIONSINSTALLED"-->
<!--         IncludeMinimum="yes" IncludeMaximum="no" />-->
<!--    </Upgrade>-->

<!--    <Upgrade Id="F849BFAF-EE21-43F8-8A9A-271DD07B4DA8">-->
<!--      <UpgradeVersion Minimum="0.1.0"-->
<!--                      IncludeMinimum="yes"-->
<!--                      Maximum="$(var.ProgramVersion)"-->
<!--                      Property="OLDERVERSIONBEINGUPGRADED" />-->
<!--    </Upgrade>-->

    <!--LaunchConditions-->
    <Condition Message="$(loc.BeAdministrator)">Privileged</Condition>
    <Condition Message="$(loc.NetFramework20Required)">FX20INSTALLED OR Installed</Condition>
    <Condition Message="$(loc.NetFramework35Required)">FX35INSTALLED OR Installed</Condition>
    <Condition Message="$(loc.VisualStudio2008Required)">VSINSTALLDIR OR Installed</Condition>

    <!--CustomActions-->
    <CustomAction Id="SetDefault_TARGETDIR" Return="check" Execute="firstSequence" Property="TARGETDIR" Value="[ProgramFilesFolder]$(loc.ProductName)" />
    <CustomAction Id="Set_DEVENV" Return="check" Execute="immediate" Property="DEVENV" Value="[VSINSTALLDIR]devenv.exe" />
    <CustomAction Id="ExecuteDevenvSetup" Property="DEVENV" Execute="deferred" Impersonate="no" ExeCommand="/setup" Return="asyncWait"/>

    <!--Install UI Sequence-->
    <InstallUISequence>
      <LaunchConditions After="AppSearch" />
      <Custom Action="Set_DEVENV" After="ValidateProductID">DEVENV=""</Custom>
      <Custom Action="SetDefault_TARGETDIR" After="Set_DEVENV">TARGETDIR=""</Custom>
      <Show Dialog="ResumeForm" After="IsolateComponents">Installed="" AND RESUME</Show>
      <Show Dialog="MaintenanceForm" After="ResumeForm"><![CDATA[Installed<>""]]></Show>
      <Show Dialog="WelcomeForm" After="CostFinalize">Installed="" AND NOT RESUME</Show>
      <Show Dialog="ProgressForm" After="WelcomeForm" />
      <Show Dialog="FatalErrorForm" OnExit="error">NOT HideFatalErrorForm</Show>
      <Show Dialog="UserExitForm" OnExit="cancel" />
      <Show Dialog="FinishedForm" OnExit="success" />
    </InstallUISequence>

    <!--Install Sequence-->
    <InstallExecuteSequence>
      <LaunchConditions After="AppSearch" />

      <Custom Action='NoDownGrade' After='FindRelatedProducts'>
        <![CDATA[PROJECT_DOWNGRADE]]>
      </Custom>

      <RemoveExistingProducts After='InstallFinalize'/>

      <Custom Action="Set_DEVENV" After="ValidateProductID">DEVENV=""</Custom>
      <Custom Action="SetDefault_TARGETDIR" After="Set_DEVENV">TARGETDIR=""</Custom>
      <Custom Action="ExecuteDevenvSetup" After="MsiPublishAssemblies" />
    </InstallExecuteSequence>

    <!--Features-->
    <Feature Id="ProductFeature" Level="1" ConfigurableDirectory="TARGETDIR">
      <ComponentRef Id="CreateTargetDirectory"/>
      <ComponentRef Id="MainFilesComponent" />
      <ComponentRef Id="PackageRegistryEntriesComponent" />
      <!--//TODO: Add reference to other components-->
      <!--
		<ComponentRef Id="ItemTemplatesFilesComponent" />
		<ComponentRef Id="ProjectTemplatesFilesComponent" />
		<ComponentRef Id="XsdFilesComponent" />
		<ComponentRef Id="OtherRegistryEntriesComponent" />
		-->
    </Feature>

    <!--Refs-->
<!--    <FragmentRef Id="UIFragment"/>-->
<!--    <FragmentRef Id="FilesFragment"/>-->
<!--    <FragmentRef Id="PackageRegistryEntriesFragment"/>-->
<!--    <FragmentRef Id="OtherRegistryEntriesFragment"/>-->

    <!--Product Icon-->
    <Icon Id="ProductIcon" SourceFile="Resources\Product.ico"/>

    <!--Bitmaps for UI-->
    <Binary Id="BannerBitmap" SourceFile="Resources\Banner.bmp" />
    <Binary Id="UpFldrBtn" SourceFile="Resources\Up.ico" />
    <Binary Id="NewFldrBtn" SourceFile="Resources\New.ico" />
  </Product>
</Wix>
